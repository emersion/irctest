# Input used by make_workflows.py to generate .github/workflows/

# See VersionFlavor in the script to see how stabl/release/devel/devel_release
# are defined.

software:

    unrealircd:
        name: UnrealIRCd 6
        repository: unrealircd/unrealircd
        refs:
            stable: cedd23ae9cdd5985ce16e9869cbdb808479c3fc4  # 6.0.3
            release: cedd23ae9cdd5985ce16e9869cbdb808479c3fc4  # 6.0.3
            devel: unreal60_dev
            devel_release: null
        path: unrealircd
        prefix: ~/.local/unrealircd
        separate_build_job: true
        build_script: &unrealircd_build_script |
            cd $GITHUB_WORKSPACE/unrealircd/
            cp $GITHUB_WORKSPACE/data/unreal/* .
            # Need to use a specific -march, because GitHub has inconsistent
            # architectures across workers, which result in random SIGILL with some
            # worker combinations
            sudo apt install libsodium-dev libargon2-dev
            CFLAGS="-O0 -march=x86-64" CXXFLAGS="$CFLAGS" ./Config -quick
            make -j 4
            make install
            # Prevent download of geoIP database on first startup
            sed -i 's/loadmodule "geoip_classic";//' ~/.local/unrealircd/conf/modules.default.conf

    unrealircd-5:
        name: UnrealIRCd 5
        repository: unrealircd/unrealircd
        refs:
            stable: 6604856973f713a494f83d38992d7d61ce6b9db4  # 5.2.4
            release: null
            devel: unreal52
            devel_release:
        path: unrealircd
        prefix: ~/.local/unrealircd
        separate_build_job: true
        build_script: *unrealircd_build_script


    #############################
    # Services:

    anope:
        name: Anope
        repository: anope/anope
        separate_build_job: true
        path: anope
        refs:
            stable: "2.0.9"
            release: "2.0.9"
            devel: "2.0.9"
            devel_release: "2.0.9"
        build_script: |
            cd $GITHUB_WORKSPACE/anope/
            cp $GITHUB_WORKSPACE/data/anope/* .
            CFLAGS=-O0 ./Config -quick
            make -C build -j 4
            make -C build install

    dlk:
        name: Dlk
        repository: DalekIRC/Dalek-Services
        separate_build_job: false
        path: Dlk-Services
        refs:
            stable: &dlk_stable "8868473ad1ee03c56aac1e6a7f85ed11b8cb2ef7"
            release: *dlk_stable
            devel: "master"
            devel_release: *dlk_stable
        build_script: |
            pip install pifpaf
            wget -q https://raw.githubusercontent.com/wp-cli/builds/gh-pages/phar/wp-cli.phar
            wget -q https://wordpress.org/latest.zip -O wordpress-latest.zip
        env: >-
            IRCTEST_DLK_PATH="${{ github.workspace }}/Dlk-Services"
            IRCTEST_WP_CLI_PATH="${{ github.workspace }}/wp-cli.phar"
            IRCTEST_WP_ZIP_PATH="${{ github.workspace }}/wordpress-latest.zip"

tests:
    unrealircd-5:
        software: [unrealircd-5]

    unrealircd:
        software: [unrealircd]

    unrealircd-dlk:
        software: [unrealircd, dlk]
